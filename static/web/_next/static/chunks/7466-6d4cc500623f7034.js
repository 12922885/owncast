"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7466],{77466:function(e,t,n){let r;n.d(t,{me:function(){return V},FI:function(){return R},Q:function(){return T},L4:function(){return I},j$:function(){return C},ZA:function(){return v},g1:function(){return O},g8:function(){return M},db:function(){return k},ap:function(){return L},di:function(){return P},pT:function(){return F},hz:function(){return _},YW:function(){return U},We:function(){return D},RI:function(){return A},pH:function(){return H},Gt:function(){return m}});var o,a,c=n(67294),i=n(4480),s=n(23917),u=class{static async getConfig(){let e=await fetch("/api/config"),t=await e.json();return t}},l=n(64777),f=class{static async getChatHistory(e){let t=await (0,l.$l)("".concat("/api/chat","?accessToken=").concat(e));return t}static async registerUser(e){let t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({displayName:e})},n=await (0,l.$l)("/api/chat/register",t);return n}},d=n(91951);class h{createAndConnect(e){let t=new URL(e);t.protocol="https:"===window.location.protocol?"wss:":"ws:",t.pathname="/ws",t.port="3000"===window.location.port?"8080":window.location.port,t.searchParams.append("accessToken",this.accessToken),console.debug("connecting to ",t.toString());let n=new WebSocket(t.toString());n.onopen=this.onOpen.bind(this),n.onerror=this.onError.bind(this),n.onmessage=this.onMessage.bind(this),this.websocket=n}onOpen(){this.websocketReconnectTimer&&clearTimeout(this.websocketReconnectTimer)}onError(e){console.error("Chat has been disconnected and is likely not working for you. It's possible you were removed from chat. If this is a server configuration issue, visit troubleshooting steps to resolve. https://owncast.online/docs/troubleshooting/#chat-is-disabled: ".concat("Socket error: ".concat(e))),this.websocket.close(),this.isShutdown||this.scheduleReconnect()}scheduleReconnect(){this.websocketReconnectTimer&&clearTimeout(this.websocketReconnectTimer),this.backOff*=2,this.websocketReconnectTimer=setTimeout(this.createAndConnect,5e3+Math.min(this.backOff,1e4))}shutdown(){this.isShutdown=!0,this.websocket.close()}onMessage(e){let t;let n=e.data.split("\n");for(let r=0;r<n.length;r++){try{t=JSON.parse(n[r]),this.handleMessage&&this.handleMessage(t)}catch(o){console.error(o,o.data);return}if(!t.type){console.error("No type provided",t);return}if(t.type===d.C.PING){this.sendPong();return}}}isConnected(){var e,t;return(null===(e=this.websocket)||void 0===e?void 0:e.readyState)===(null===(t=this.websocket)||void 0===t?void 0:t.OPEN)}send(e){e.type&&d.C[e.type]||console.warn('Outbound message: Unknown socket message type: "'.concat(e.type,'" sent.'));let t=JSON.stringify(e);this.websocket.send(t)}sendPong(){let e={type:d.C.PONG};this.send(e)}constructor(e,t,n){this.isShutdown=!1,this.backOff=1e3,this.accessToken=e,this.path=t,this.websocketReconnectTimer=null,this.isShutdown=!1,this.createAndConnect=this.createAndConnect.bind(this),this.shutdown=this.shutdown.bind(this),this.createAndConnect(n)}}var E=n(4723);(o=a||(a={})).Loading="LOADING",o.Loaded="LOADED",o.Online="ONLINE",o.Offline="OFFLINE",o.NeedsRegister="NEEDS_REGISTER",o.Fail="FAIL";let g=(0,E.C)({id:"appState",initial:"loading",predictableActionArguments:!0,states:{loading:{meta:{chatAvailable:!1,chatLoading:!1,videoAvailable:!1,appLoading:!0},on:{NEEDS_REGISTER:{target:"loading"},LOADED:{target:"ready"},FAIL:{target:"serverFailure"}}},ready:{initial:"offline",states:{online:{meta:{chatAvailable:!0,chatLoading:!1,videoAvailable:!0,appLoading:!1},on:{OFFLINE:{target:"goodbye"}}},offline:{meta:{chatAvailable:!1,chatLoading:!1,videoAvailable:!1,appLoading:!1},on:{ONLINE:{target:"online"}}},goodbye:{on:{ONLINE:{target:"online"}},meta:{chatAvailable:!0,chatLoading:!1,videoAvailable:!1,appLoading:!1},after:{3e5:{target:"offline"}}}}},serverFailure:{type:"final"},userfailure:{type:"final"}}});var y=n(72581),w=n(77278),p=function(e,t,n){let{user:r}=e,{id:o,displayName:a,displayColor:c,scopes:i,authenticated:s}=r;t(s),n({id:o.toString(),displayName:a,displayColor:c,isModerator:null==i?void 0:i.includes("MODERATOR")})},N=class{static async getStatus(){let e=await fetch("/api/status"),t=await e.json();return t}},b=function(e,t){t(t=>[...t,e])};i.zl.RECOIL_DUPLICATE_ATOM_KEY_CHECKING_ENABLED=!1;let S="accessToken",A=(0,i.cn)({key:"serverStatusState",default:{online:!1,viewerCount:0,serverTime:new Date}}),O=(0,i.cn)({key:"clientConfigState",default:{name:"",summary:"",offlineMessage:"",logo:"",tags:[],version:"",nsfw:!1,extraPageContent:"",socialHandles:[],chatDisabled:!1,externalActions:[],customStyles:"",appearanceVariables:new Map,maxSocketPayloadSize:0,federation:{enabled:!1,account:"",followerCount:0},notifications:{browser:{enabled:!1,publicKey:""}},authentication:{indieAuthEnabled:!1}}}),R=(0,i.cn)({key:"accessTokenAtom",default:null}),k=(0,i.cn)({key:"currentUserAtom",default:null}),C=(0,i.cn)({key:"chatMessages",default:[]}),I=(0,i.cn)({key:"chatAuthenticatedAtom",default:!1}),m=(0,i.cn)({key:"websocketServiceAtom",default:null,dangerouslyAllowMutability:!0}),T=(0,i.cn)({key:"appState",default:{chatAvailable:!1,chatLoading:!0,videoAvailable:!1,appLoading:!0}}),_=(0,i.cn)({key:"isMobileAtom",default:void 0}),v=(0,i.cn)({key:"chatVisibilityToggleAtom",default:!0}),D=(0,i.cn)({key:"isVideoPlayingAtom",default:!1}),L=(0,i.cn)({key:"fatalErrorStateAtom",default:null}),M=(0,i.cn)({key:"clockSkewAtom",default:0}),G=(0,i.cn)({key:"removedMessageIds",default:[]}),F=(0,i.nZ)({key:"isChatVisibleSelector",get:e=>{let{get:t}=e,n=t(T),r=t(v),o=t(R);return o&&n.chatAvailable&&r}}),P=(0,i.nZ)({key:"isChatAvailableSelector",get:e=>{let{get:t}=e,n=t(T),r=t(R);return r&&n.chatAvailable}}),U=(0,i.nZ)({key:"isOnlineSelector",get:e=>{let{get:t}=e,n=t(T),r=t(D);return n.videoAvailable||r}}),H=(0,i.nZ)({key:"visibleChatMessagesSelector",get:e=>{let{get:t}=e,n=t(C),r=t(G);return n.filter(e=>!r.includes(e.id))}}),V=()=>{let e;let[t,n,o]=(0,s.e)(g),[l,E]=(0,i.FV)(k),_=(0,i.Zl)(I),[v,D]=(0,i.FV)(O),[F,P]=(0,i.FV)(A),U=(0,i.Zl)(M),[H,V]=(0,i.FV)(C),[Y,B]=(0,i.FV)(R),j=(0,i.Zl)(T),J=(0,i.Zl)(L),Z=(0,i.Zl)(m),[W,$]=(0,i.FV)(G),[,K]=(0,c.useState)(!1),[Q,X]=(0,c.useState)(!1),q=(e,t)=>{J({title:e,message:t})},x=e=>{n({type:e})},z=e=>{if(t.matches("loading")){x(a.Loaded);return}e.online&&t.matches("ready")?x(a.Online):e.online||t.matches("ready.offline")||x(a.Offline)},ee=async()=>{try{let e=await u.getConfig();D(e),J(null),X(!0)}catch(t){q("Unable to reach Owncast server","Owncast cannot launch. Please make sure the Owncast server is running."),console.error("ClientConfigService -> getConfig() ERROR: \n".concat(t))}},et=async()=>{try{let e=await N.getStatus();P(e),K(!0);let{serverTime:t}=e,n=new Date(t).getTime()-Date.now();U(n),J(null)}catch(r){x(a.Fail),q("Unable to reach Owncast server","Owncast cannot launch. Please make sure the Owncast server is running."),console.error("serverStatusState -> getStatus() ERROR: \n".concat(r))}},en=async e=>{let t=(0,y.$o)(S);if(t){B(t);return}try{x(a.NeedsRegister);let n=await f.registerUser(e),{accessToken:r,displayName:o,displayColor:c}=n;if(!r)return;E({...l,displayName:o,displayColor:c}),B(r),(0,y.qQ)(S,r)}catch(i){x(a.Fail),console.error("ChatService -> registerUser() ERROR: \n".concat(i))}},er=()=>{(0,y.qQ)(S,""),B(null),en()},eo=e=>{let{ids:t,visible:n}=e;if(n){let r=W.filter(e=>!t.includes(e));$(r)}else{let o=[...W,...t];$(o)}},ea=e=>{switch(e.type){case d.C.ERROR_NEEDS_REGISTRATION:er();break;case d.C.CONNECTED_USER_INFO:p(e,_,E),V(t=>[...t,e]);break;case d.C.CHAT:V(t=>[...t,e]);break;case d.C.NAME_CHANGE:b(e,V);break;case d.C.USER_JOINED:V(t=>[...t,e]);break;case d.C.SYSTEM:V(t=>[...t,e]);break;case d.C.CHAT_ACTION:V(t=>[...t,e]);break;case d.C.VISIBILITY_UPDATE:eo(e);break;default:console.error("Unknown socket message type: ",e.type)}},ec=async()=>{try{let e=await f.getChatHistory(Y);V(t=>[...t,...e])}catch(t){console.error("ChatService -> getChatHistory() ERROR: \n".concat(t))}},ei=async()=>{try{let{socketHostOverride:t}=v,n=t||window.location.toString();(e=new h(Y,"/ws",n)).handleMessage=ea,Z(e)}catch(r){console.error("ChatService -> startChat() ERROR: \n".concat(r))}},es=()=>{};return(0,c.useEffect)(()=>{try{if(window.configHydration){let e=JSON.parse(window.configHydration);D(e),X(!0)}}catch(t){console.error("Error parsing config hydration",t)}try{if(window.statusHydration){let n=JSON.parse(window.statusHydration);P(n),K(!0)}}catch(r){console.error("error parsing status hydration",r)}},[]),(0,c.useEffect)(()=>{z(F)},[F]),(0,c.useEffect)(()=>{!v.chatDisabled&&Y&&Q&&ei()},[Q,Y]),(0,c.useEffect)(()=>{es()},[H]),(0,c.useEffect)(()=>(ee(),en(),et(),clearInterval(r),r=setInterval(()=>{et()},5e3),()=>{clearInterval(r)}),[]),(0,c.useEffect)(()=>{Y&&ec()},[Y]),(0,c.useEffect)(()=>{o.onTransition(e=>{let t=(0,w.YR)(e.meta);j(t)})},[]),null}},91951:function(e,t,n){var r,o;n.d(t,{C:function(){return r}}),(o=r||(r={})).CHAT="CHAT",o.PING="PING",o.NAME_CHANGE="NAME_CHANGE",o.COLOR_CHANGE="COLOR_CHANGE",o.PONG="PONG",o.SYSTEM="SYSTEM",o.USER_JOINED="USER_JOINED",o.CHAT_ACTION="CHAT_ACTION",o.FEDIVERSE_ENGAGEMENT_FOLLOW="FEDIVERSE_ENGAGEMENT_FOLLOW",o.FEDIVERSE_ENGAGEMENT_LIKE="FEDIVERSE_ENGAGEMENT_LIKE",o.FEDIVERSE_ENGAGEMENT_REPOST="FEDIVERSE_ENGAGEMENT_REPOST",o.CONNECTED_USER_INFO="CONNECTED_USER_INFO",o.ERROR_USER_DISABLED="ERROR_USER_DISABLED",o.ERROR_NEEDS_REGISTRATION="ERROR_NEEDS_REGISTRATION",o.ERROR_MAX_CONNECTIONS_EXCEEDED="ERROR_MAX_CONNECTIONS_EXCEEDED",o.VISIBILITY_UPDATE="VISIBILITY-UPDATE"},64777:function(e,t,n){n.d(t,{$i:function(){return M},$l:function(){return Z},Bu:function(){return w},E8:function(){return P},Ff:function(){return I},GC:function(){return b},GR:function(){return Q},HP:function(){return F},IO:function(){return _},Kp:function(){return E},Kt:function(){return $},M_:function(){return D},N$:function(){return Y},NE:function(){return s},NM:function(){return y},Q_:function(){return u},Qc:function(){return C},RB:function(){return p},UJ:function(){return j},WB:function(){return c},WE:function(){return R},WQ:function(){return O},Wr:function(){return T},XA:function(){return v},Y9:function(){return U},a_:function(){return h},ao:function(){return f},bl:function(){return l},e_:function(){return G},hn:function(){return k},iG:function(){return L},iV:function(){return d},jr:function(){return N},kb:function(){return H},kg:function(){return W},ms:function(){return m},nx:function(){return S},op:function(){return V},qk:function(){return g},rQ:function(){return J},sG:function(){return A},um:function(){return B}});var r=n(34155);let o=r.env.NEXT_PUBLIC_ADMIN_USERNAME,a=r.env.NEXT_PUBLIC_ADMIN_STREAMKEY,c="/",i="".concat(c,"api/admin/"),s=15e3,u="".concat(i,"status"),l="".concat(i,"serverconfig"),f="".concat(i,"config"),d="".concat(i,"viewersOverTime"),h="".concat(i,"viewers"),E="".concat(i,"chat/clients"),g="".concat(i,"chat/users/disabled"),y="".concat(i,"chat/users/setenabled"),w="".concat(i,"chat/users/ipbans"),p="".concat(i,"chat/users/ipbans/remove"),N="".concat(i,"chat/users/setmoderator"),b="".concat(i,"chat/users/moderators"),S="".concat(i,"hardwarestats"),A="".concat(i,"logs"),O="".concat(i,"logs/warnings"),R="".concat(i,"chat/messages"),k="/api/admin/chat/messagevisibility",C="".concat(i,"emoji/upload"),I="".concat(i,"emoji/delete"),m="".concat(i,"accesstokens"),T="".concat(i,"accesstokens/delete"),_="".concat(i,"accesstokens/create"),v="".concat(i,"webhooks"),D="".concat(i,"webhooks/delete"),L="".concat(i,"webhooks/create"),M="".concat(c,"api/socialplatforms"),G="".concat(i,"federation/send"),F="".concat(i,"followers"),P="".concat(i,"followers/pending"),U="".concat(i,"followers/blocked"),H="".concat(i,"followers/approve"),V="".concat(i,"federation/actions"),Y="".concat(i,"metrics/video"),B="".concat(i,"config/streamkeys"),j="".concat(i,"yp/reset");async function J(e,t){let{data:n,method:r="GET",auth:c=!0}=t||{},i={method:r};if(n&&(i.body=JSON.stringify(n)),c&&o&&a){let s=btoa("".concat(o,":").concat(a));i.headers={Authorization:"Basic ".concat(s)},i.mode="cors",i.credentials="include"}try{let u=await fetch(e,i),l=await u.json();if(!u.ok){let f=l.message||"An error has occurred: ".concat(u.status);throw Error(f)}return l}catch(d){return console.error(d),d}}async function Z(e,t){let n={method:"GET",auth:!1,...t};return J(e,n)}async function W(e){try{let t=await fetch(e,{referrerPolicy:"no-referrer",referrer:""});if(!t.ok){let n="An error has occured: ".concat(t.status);throw Error(n)}let r=await t.json();return r}catch(o){console.log(o)}return{}}async function $(){return W("https://api.github.com/repos/owncast/owncast/releases/latest")}let K=/^\d+(\.\d+){0,2}$/;async function Q(e){let t=await $(),n=t.tag_name;return("v"===n.substr(0,1)&&(n=n.substr(1)),!function(e,t){if(!e||!t||0===e.length||0===t.length)return!1;if(e===t)return!0;if(K.test(e)&&K.test(t)){let n=e.split(".");for(;n.length<3;)n.push("0");let r=t.split(".");for(;r.length<3;)r.push("0");for(let o=0;o<3;o++){let a=parseInt(n[o],10),c=parseInt(r[o],10);if(a!==c)return a>c}return!0}return e>=t}(e,n))?n:null}},77278:function(e,t,n){function r(e){let t="string"==typeof e?new Date(e):e;return(new Date-t)/864e5}function o(e){return Object.keys(e).reduce((t,n)=>{let r=e[n];return Object.assign(t,r),t},{})}n.d(t,{Xb:function(){return r},YR:function(){return o}})},72581:function(e,t,n){n.d(t,{$o:function(){return o},dA:function(){return r},qQ:function(){return a}});let r={username:"username",hasDisplayedNotificationModal:"HAS_DISPLAYED_NOTIFICATION_MODAL",userVisitCount:"USER_VISIT_COUNT"};function o(e){try{return localStorage.getItem(e)}catch(t){}return null}function a(e,t){try{return""!==t&&null!==t?localStorage.setItem(e,t):localStorage.removeItem(e),!0}catch(n){}return!1}}}]);
//# sourceMappingURL=7466-6d4cc500623f7034.js.map