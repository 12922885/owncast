"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1899],{1899:function(e,t,n){n.d(t,{me:function(){return W},FI:function(){return D},Q:function(){return x},L4:function(){return L},nk:function(){return m},w4:function(){return T},uy:function(){return _},ZA:function(){return F},g1:function(){return I},g8:function(){return V},ap:function(){return P},di:function(){return J},fE:function(){return w},pT:function(){return Y},hz:function(){return M},YW:function(){return j},We:function(){return U},RI:function(){return C},pH:function(){return B},Gt:function(){return G}});var r=n(47568),a=n(828),o=n(29815),c=n(34051),i=n.n(c),s=n(67294),u=n(4480),l=n(23917);var f=n(51438),d=function(){function e(){(0,f.Z)(this,e)}return e.getConfig=function(){return(0,r.Z)(i().mark((function e(){var t,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("http://localhost:8080/api/config");case 2:return t=e.sent,e.next=5,t.json();case 5:return n=e.sent,e.abrupt("return",n);case 7:case"end":return e.stop()}}),e)})))()},e}(),E=n(58827),p=function(){function e(){(0,f.Z)(this,e)}return e.getChatHistory=function(e){return(0,r.Z)(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,E.$l)("".concat("/api/chat","?accessToken=").concat(e));case 2:return n=t.sent,t.abrupt("return",n);case 4:case"end":return t.stop()}}),t)})))()},e.registerUser=function(e){return(0,r.Z)(i().mark((function t(){var n,r;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({displayName:e})},t.next=3,(0,E.$l)("/api/chat/register",n);case 3:return r=t.sent,t.abrupt("return",r);case 5:case"end":return t.stop()}}),t)})))()},e}(),h=n(11622),v=function(){function e(t,n){(0,f.Z)(this,e),this.accessToken=t,this.path=n,this.createAndConnect()}var t=e.prototype;return t.createAndConnect=function(){var e=new URL("ws://localhost:8080/ws");e.searchParams.append("accessToken",this.accessToken),console.debug("connecting to ",e.toString());var t=new WebSocket(e.toString());t.onopen=this.onOpen.bind(this),t.onerror=this.onError.bind(this),t.onmessage=this.onMessage.bind(this),this.websocket=t},t.onOpen=function(){this.websocketReconnectTimer&&clearTimeout(this.websocketReconnectTimer)},t.onError=function(e){var t;console.error(e),t="Socket error: ".concat(e),console.error("Chat has been disconnected and is likely not working for you. It's possible you were removed from chat. If this is a server configuration issue, visit troubleshooting steps to resolve. https://owncast.online/docs/troubleshooting/#chat-is-disabled: ".concat(t)),this.websocket.close()},t.onMessage=function(e){for(var t,n=e.data.split("\n"),r=0;r<n.length;r++){try{t=JSON.parse(n[r]),this.handleMessage&&this.handleMessage(t)}catch(a){return void console.error(a,a.data)}if(!t.type)return void console.error("No type provided",t);if(t.type===h.C.PING)return void this.sendPong()}},t.isConnected=function(){var e,t;return(null===(e=this.websocket)||void 0===e?void 0:e.readyState)===(null===(t=this.websocket)||void 0===t?void 0:t.OPEN)},t.send=function(e){e.type&&h.C[e.type]||console.warn('Outbound message: Unknown socket message type: "'.concat(e.type,'" sent.'));var t=JSON.stringify(e);this.websocket.send(t)},t.sendPong=function(){var e={type:h.C.PONG};this.send(e)},e}();var g=n(26042),N=n(4723);var S;!function(e){e.Loading="LOADING",e.Loaded="LOADED",e.Online="ONLINE",e.Offline="OFFLINE",e.NeedsRegister="NEEDS_REGISTER",e.Fail="FAIL"}(S||(S={}));var O=(0,N.C)({id:"appState",initial:"loading",predictableActionArguments:!0,states:{loading:{meta:(0,g.Z)({},{chatAvailable:!1,chatLoading:!1,videoAvailable:!1,appLoading:!0}),on:{NEEDS_REGISTER:{target:"loading"},LOADED:{target:"ready"},FAIL:{target:"serverFailure"}}},ready:{initial:"offline",states:{online:{meta:(0,g.Z)({},{chatAvailable:!0,chatLoading:!1,videoAvailable:!0,appLoading:!1}),on:{OFFLINE:{target:"goodbye"}}},offline:{meta:(0,g.Z)({},{chatAvailable:!1,chatLoading:!1,videoAvailable:!1,appLoading:!1}),on:{ONLINE:{target:"online"}}},goodbye:{on:{ONLINE:{target:"online"}},meta:(0,g.Z)({},{chatAvailable:!0,chatLoading:!1,videoAvailable:!1,appLoading:!1}),after:{3e5:{target:"offline"}}}}},serverFailure:{type:"final"},userfailure:{type:"final"}}}),k=n(73682);var y=function(e,t,n,r,a,o){var c=e.user,i=c.id,s=c.displayName,u=c.displayColor,l=c.scopes,f=c.authenticated;t(s),n(u),r(i),a(null===l||void 0===l?void 0:l.includes("MODERATOR")),o(f)},A=function(){function e(){(0,f.Z)(this,e)}return e.getStatus=function(){return(0,r.Z)(i().mark((function e(){var t,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("/api/status");case 2:return t=e.sent,e.next=5,t.json();case 5:return n=e.sent,e.abrupt("return",n);case 7:case"end":return e.stop()}}),e)})))()},e}();var b=function(e,t,n){n((0,o.Z)(t).concat([e]))},R="accessToken",C=(0,u.cn)({key:"serverStatusState",default:{online:!1,viewerCount:0,serverTime:new Date}}),I=(0,u.cn)({key:"clientConfigState",default:{name:"",summary:"",offlineMessage:"",logo:"",tags:[],version:"",nsfw:!1,extraPageContent:"",socialHandles:[],chatDisabled:!1,externalActions:[],customStyles:"",maxSocketPayloadSize:0,federation:{enabled:!1,account:"",followerCount:0},notifications:{browser:{enabled:!1,publicKey:""}},authentication:{indieAuthEnabled:!1}}}),T=(0,u.cn)({key:"chatDisplayName",default:null}),m=(0,u.cn)({key:"chatDisplayColor",default:null}),_=(0,u.cn)({key:"chatUserIdAtom",default:null}),w=(0,u.cn)({key:"isModeratorAtom",default:!1}),D=(0,u.cn)({key:"accessTokenAtom",default:null}),Z=(0,u.cn)({key:"chatMessages",default:[]}),L=(0,u.cn)({key:"chatAuthenticatedAtom",default:!1}),G=(0,u.cn)({key:"websocketServiceAtom",default:null}),x=(0,u.cn)({key:"appState",default:{chatAvailable:!1,chatLoading:!0,videoAvailable:!1,appLoading:!0}}),M=(0,u.cn)({key:"isMobileAtom",default:void 0}),F=(0,u.cn)({key:"chatVisibilityToggleAtom",default:!0}),U=(0,u.cn)({key:"isVideoPlayingAtom",default:!1}),P=(0,u.cn)({key:"fatalErrorStateAtom",default:null}),V=(0,u.cn)({key:"clockSkewAtom",default:0}),H=(0,u.cn)({key:"removedMessageIds",default:[]}),Y=(0,u.nZ)({key:"isChatVisibleSelector",get:function(e){var t=e.get,n=t(x),r=t(F);return t(D)&&n.chatAvailable&&r}}),J=(0,u.nZ)({key:"isChatAvailableSelector",get:function(e){var t=e.get,n=t(x);return t(D)&&n.chatAvailable}}),j=(0,u.nZ)({key:"isOnlineSelector",get:function(e){var t=e.get,n=t(x),r=t(U);return n.videoAvailable||r}}),B=(0,u.nZ)({key:"visibleChatMessagesSelector",get:function(e){var t=e.get,n=t(Z),r=t(H);return n.filter((function(e){return!r.includes(e.id)}))}});var W=function(){var e,t=(0,a.Z)((0,l.e)(O),3),n=t[0],c=t[1],f=t[2],E=(0,u.Zl)(T),g=(0,u.Zl)(m),N=(0,u.Zl)(_),M=(0,u.Zl)(L),F=(0,u.Zl)(w),U=(0,u.Zl)(I),Y=(0,u.Zl)(C),J=(0,u.Zl)(V),j=(0,a.Z)((0,u.FV)(Z),2),B=j[0],W=j[1],Q=(0,a.Z)((0,u.FV)(D),2),X=Q[0],$=Q[1],q=(0,u.Zl)(x),K=(0,u.Zl)(P),z=(0,u.Zl)(G),ee=(0,a.Z)((0,u.FV)(H),2),te=ee[0],ne=ee[1],re=function(e,t){K({title:e,message:t})},ae=function(e){c({type:e})},oe=function(){var e=(0,r.Z)(i().mark((function e(){var t;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,d.getConfig();case 3:t=e.sent,U(t),ae("LOADED"),K(null),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),re("Unable to reach Owncast server","Owncast cannot launch. Please make sure the Owncast server is running. ".concat(e.t0)),console.error("ClientConfigService -> getConfig() ERROR: \n".concat(e.t0));case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(){return e.apply(this,arguments)}}(),ce=function(){var e=(0,r.Z)(i().mark((function e(){var t,n,r;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,A.getStatus();case 3:t=e.sent,Y(t),n=t.serverTime,r=new Date(n).getTime()-Date.now(),J(r),t.online?ae(S.Online):t.online||ae(S.Offline),K(null),e.next=17;break;case 12:e.prev=12,e.t0=e.catch(0),ae(S.Fail),re("Unable to reach Owncast server","Owncast cannot launch. Please make sure the Owncast server is running. ".concat(e.t0)),console.error("serverStatusState -> getStatus() ERROR: \n".concat(e.t0));case 17:return e.abrupt("return",null);case 18:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(){return e.apply(this,arguments)}}(),ie=function(){var e=(0,r.Z)(i().mark((function e(t){var n,r,a,o,c;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=(0,k.$o)(R))){e.next=4;break}return $(n),e.abrupt("return");case 4:return e.prev=4,ae(S.NeedsRegister),e.next=8,p.registerUser(t);case 8:if(r=e.sent,console.log("ChatService -> registerUser() response: \n".concat(r)),a=r.accessToken,o=r.displayName,c=r.displayColor,a){e.next=13;break}return e.abrupt("return");case 13:console.log("setting access token",a),$(a),(0,k.qQ)(R,a),E(o),g(c),e.next=24;break;case 20:e.prev=20,e.t0=e.catch(4),ae(S.Fail),console.error("ChatService -> registerUser() ERROR: \n".concat(e.t0));case 24:case"end":return e.stop()}}),e,null,[[4,20]])})));return function(t){return e.apply(this,arguments)}}(),se=function(e){switch(e.type){case h.C.ERROR_NEEDS_REGISTRATION:(0,k.qQ)(R,""),$(""),ie();break;case h.C.CONNECTED_USER_INFO:y(e,E,g,N,F,M),W((function(t){return(0,o.Z)(t).concat([e])}));break;case h.C.CHAT:W((function(t){return(0,o.Z)(t).concat([e])}));break;case h.C.NAME_CHANGE:b(e,B,W);break;case h.C.USER_JOINED:case h.C.SYSTEM:W((function(t){return(0,o.Z)(t).concat([e])}));break;case h.C.VISIBILITY_UPDATE:!function(e){var t=e.ids;if(e.visible){var n=te.filter((function(e){return!t.includes(e)}));ne(n)}else{var r=(0,o.Z)(te).concat((0,o.Z)(t));ne(r)}}(e);break;default:console.error("Unknown socket message type: ",e.type)}},ue=function(){var e=(0,r.Z)(i().mark((function e(){var t;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,p.getChatHistory(X);case 3:t=e.sent,W((function(e){return(0,o.Z)(e).concat((0,o.Z)(t))})),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),console.error("ChatService -> getChatHistory() ERROR: \n".concat(e.t0));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(){return e.apply(this,arguments)}}(),le=function(){var t=(0,r.Z)(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:ae(S.Loading);try{(e=new v(X,"/ws")).handleMessage=se,z(e),ae(S.Loaded)}catch(n){console.error("ChatService -> startChat() ERROR: \n".concat(n))}case 2:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();return(0,s.useEffect)((function(){oe(),ie(),ce(),setInterval((function(){ce()}),5e3)}),[n]),(0,s.useEffect)((function(){X&&(ue(),le())}),[X]),(0,s.useEffect)((function(){f.onTransition((function(e){if(e.changed){var t,n=(t=e.meta,Object.keys(t).reduce((function(e,n){var r=t[n];return Object.assign(e,r),e}),{}));q(n)}}))})),null}},11622:function(e,t,n){var r;n.d(t,{C:function(){return r}}),function(e){e.CHAT="CHAT",e.PING="PING",e.NAME_CHANGE="NAME_CHANGE",e.COLOR_CHANGE="COLOR_CHANGE",e.PONG="PONG",e.SYSTEM="SYSTEM",e.USER_JOINED="USER_JOINED",e.CHAT_ACTION="CHAT_ACTION",e.FEDIVERSE_ENGAGEMENT_FOLLOW="FEDIVERSE_ENGAGEMENT_FOLLOW",e.FEDIVERSE_ENGAGEMENT_LIKE="FEDIVERSE_ENGAGEMENT_LIKE",e.FEDIVERSE_ENGAGEMENT_REPOST="FEDIVERSE_ENGAGEMENT_REPOST",e.CONNECTED_USER_INFO="CONNECTED_USER_INFO",e.ERROR_USER_DISABLED="ERROR_USER_DISABLED",e.ERROR_NEEDS_REGISTRATION="ERROR_NEEDS_REGISTRATION",e.ERROR_MAX_CONNECTIONS_EXCEEDED="ERROR_MAX_CONNECTIONS_EXCEEDED",e.VISIBILITY_UPDATE="VISIBILITY-UPDATE"}(r||(r={}))},73682:function(e,t,n){n.d(t,{$o:function(){return a},dA:function(){return r},qQ:function(){return o}});var r={username:"username",hasDisplayedNotificationModal:"HAS_DISPLAYED_NOTIFICATION_MODAL",userVisitCount:"USER_VISIT_COUNT"};function a(e){try{return localStorage.getItem(e)}catch(t){}return null}function o(e,t){try{return""!==t&&null!==t?localStorage.setItem(e,t):localStorage.removeItem(e),!0}catch(n){}return!1}}}]);