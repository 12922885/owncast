"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7466],{77466:function(e,t,n){let a;n.d(t,{me:function(){return V},FI:function(){return C},Q:function(){return v},L4:function(){return k},j$:function(){return I},ZA:function(){return m},g1:function(){return b},g8:function(){return G},db:function(){return p},ap:function(){return L},di:function(){return U},pT:function(){return F},hz:function(){return _},YW:function(){return P},We:function(){return D},RI:function(){return A},pH:function(){return H},Gt:function(){return T}});var o,i,r=n(67294),s=n(4480),c=n(23917),l=class{static async getConfig(){let e=await fetch("/api/config"),t=await e.json();return t}},u=n(64777),d=class{static async getChatHistory(e){let t=await (0,u.$l)("".concat("/api/chat","?accessToken=").concat(e));return t}static async registerUser(e){let t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({displayName:e})},n=await (0,u.$l)("/api/chat/register",t);return n}},E=n(91951);class h{createAndConnect(e){let t=new URL(e);t.protocol="https:"===window.location.protocol?"wss:":"ws:",t.pathname="/ws",t.port="3000"===window.location.port?"8080":window.location.port,t.searchParams.append("accessToken",this.accessToken),console.debug("connecting to ",t.toString());let n=new WebSocket(t.toString());n.onopen=this.onOpen.bind(this),n.onerror=this.onError.bind(this),n.onmessage=this.onMessage.bind(this),this.websocket=n}onOpen(){this.websocketReconnectTimer&&clearTimeout(this.websocketReconnectTimer)}onError(e){console.error("Chat has been disconnected and is likely not working for you. It's possible you were removed from chat. If this is a server configuration issue, visit troubleshooting steps to resolve. https://owncast.online/docs/troubleshooting/#chat-is-disabled: ".concat("Socket error: ".concat(e))),this.websocket.close(),this.isShutdown||this.scheduleReconnect()}scheduleReconnect(){this.websocketReconnectTimer&&clearTimeout(this.websocketReconnectTimer),this.backOff*=2,this.websocketReconnectTimer=setTimeout(this.createAndConnect,5e3+Math.min(this.backOff,1e4))}shutdown(){this.isShutdown=!0,this.websocket.close()}onMessage(e){let t;let n=e.data.split("\n");for(let a=0;a<n.length;a++){try{t=JSON.parse(n[a]),this.handleMessage&&this.handleMessage(t)}catch(o){console.error(o,o.data);return}if(!t.type){console.error("No type provided",t);return}if(t.type===E.C.PING){this.sendPong();return}}}isConnected(){var e,t;return(null===(e=this.websocket)||void 0===e?void 0:e.readyState)===(null===(t=this.websocket)||void 0===t?void 0:t.OPEN)}send(e){e.type&&E.C[e.type]||console.warn('Outbound message: Unknown socket message type: "'.concat(e.type,'" sent.'));let t=JSON.stringify(e);this.websocket.send(t)}sendPong(){let e={type:E.C.PONG};this.send(e)}constructor(e,t,n){this.isShutdown=!1,this.backOff=1e3,this.accessToken=e,this.path=t,this.websocketReconnectTimer=null,this.isShutdown=!1,this.createAndConnect=this.createAndConnect.bind(this),this.shutdown=this.shutdown.bind(this),this.createAndConnect(n)}}var f=n(4723);(o=i||(i={})).Loading="LOADING",o.Loaded="LOADED",o.Online="ONLINE",o.Offline="OFFLINE",o.NeedsRegister="NEEDS_REGISTER",o.Fail="FAIL";let g=(0,f.C)({id:"appState",initial:"loading",predictableActionArguments:!0,states:{loading:{meta:{chatAvailable:!1,chatLoading:!1,videoAvailable:!1,appLoading:!0},on:{NEEDS_REGISTER:{target:"loading"},LOADED:{target:"ready"},FAIL:{target:"serverFailure"}}},ready:{initial:"offline",states:{online:{meta:{chatAvailable:!0,chatLoading:!1,videoAvailable:!0,appLoading:!1},on:{OFFLINE:{target:"goodbye"}}},offline:{meta:{chatAvailable:!1,chatLoading:!1,videoAvailable:!1,appLoading:!1},on:{ONLINE:{target:"online"}}},goodbye:{on:{ONLINE:{target:"online"}},meta:{chatAvailable:!0,chatLoading:!1,videoAvailable:!1,appLoading:!1},after:{3e5:{target:"offline"}}}}},serverFailure:{type:"final"},userfailure:{type:"final"}}});var S=n(72581),y=n(77278),O=function(e,t,n){let{user:a}=e,{id:o,displayName:i,displayColor:r,scopes:s,authenticated:c}=a;t(c),n({id:o.toString(),displayName:i,displayColor:r,isModerator:null==s?void 0:s.includes("MODERATOR")})},N=class{static async getStatus(){let e=await fetch("/api/status"),t=await e.json();return t}},R=function(e,t,n){let a=[...t,e];n(a)};let w="accessToken",A=(0,s.cn)({key:"serverStatusState",default:{online:!1,viewerCount:0,serverTime:new Date}}),b=(0,s.cn)({key:"clientConfigState",default:{name:"",summary:"",offlineMessage:"",logo:"",tags:[],version:"",nsfw:!1,extraPageContent:"",socialHandles:[],chatDisabled:!1,externalActions:[],customStyles:"",maxSocketPayloadSize:0,federation:{enabled:!1,account:"",followerCount:0},notifications:{browser:{enabled:!1,publicKey:""}},authentication:{indieAuthEnabled:!1}}}),C=(0,s.cn)({key:"accessTokenAtom",default:null}),p=(0,s.cn)({key:"currentUserAtom",default:null}),I=(0,s.cn)({key:"chatMessages",default:[]}),k=(0,s.cn)({key:"chatAuthenticatedAtom",default:!1}),T=(0,s.cn)({key:"websocketServiceAtom",default:null,dangerouslyAllowMutability:!0}),v=(0,s.cn)({key:"appState",default:{chatAvailable:!1,chatLoading:!0,videoAvailable:!1,appLoading:!0}}),_=(0,s.cn)({key:"isMobileAtom",default:void 0}),m=(0,s.cn)({key:"chatVisibilityToggleAtom",default:!0}),D=(0,s.cn)({key:"isVideoPlayingAtom",default:!1}),L=(0,s.cn)({key:"fatalErrorStateAtom",default:null}),G=(0,s.cn)({key:"clockSkewAtom",default:0}),M=(0,s.cn)({key:"removedMessageIds",default:[]}),F=(0,s.nZ)({key:"isChatVisibleSelector",get(e){let{get:t}=e,n=t(v),a=t(m),o=t(C);return o&&n.chatAvailable&&a}}),U=(0,s.nZ)({key:"isChatAvailableSelector",get(e){let{get:t}=e,n=t(v),a=t(C);return a&&n.chatAvailable}}),P=(0,s.nZ)({key:"isOnlineSelector",get(e){let{get:t}=e,n=t(v),a=t(D);return n.videoAvailable||a}}),H=(0,s.nZ)({key:"visibleChatMessagesSelector",get(e){let{get:t}=e,n=t(I),a=t(M);return n.filter(e=>!a.includes(e.id))}}),V=()=>{let e;let[,t,n]=(0,c.e)(g),[o,u]=(0,s.FV)(p),f=(0,s.Zl)(k),[_,m]=(0,s.FV)(b),D=(0,s.Zl)(A),F=(0,s.Zl)(G),[U,P]=(0,s.FV)(I),[H,V]=(0,s.FV)(C),Z=(0,s.Zl)(v),Y=(0,s.Zl)(L),J=(0,s.Zl)(T),[j,B]=(0,s.FV)(M),[W,X]=(0,r.useState)(!1),[$,Q]=(0,r.useState)(!1),q=(e,t)=>{Y({title:e,message:t})},x=e=>{t({type:e})},K=async()=>{if(!$)try{let e=await l.getConfig();m(e),Y(null),Q(!0)}catch(t){q("Unable to reach Owncast server","Owncast cannot launch. Please make sure the Owncast server is running."),console.error("ClientConfigService -> getConfig() ERROR: \n".concat(t))}},z=async()=>{if(!W)try{let e=await N.getStatus();D(e),X(!0);let{serverTime:t}=e,n=new Date(t).getTime()-Date.now();F(n),e.online?x(i.Online):e.online||x(i.Offline),Y(null)}catch(a){x(i.Fail),q("Unable to reach Owncast server","Owncast cannot launch. Please make sure the Owncast server is running."),console.error("serverStatusState -> getStatus() ERROR: \n".concat(a))}},ee=async e=>{let t=(0,S.$o)(w);if(t){V(t);return}try{x(i.NeedsRegister);let n=await d.registerUser(e);console.log("ChatService -> registerUser() response: \n".concat(n));let{accessToken:a,displayName:r,displayColor:s}=n;if(!a)return;console.log("setting access token",a),u({...o,displayName:r,displayColor:s}),V(a),(0,S.qQ)(w,a)}catch(c){x(i.Fail),console.error("ChatService -> registerUser() ERROR: \n".concat(c))}},et=()=>{(0,S.qQ)(w,""),V(null),ee()},en=e=>{let{ids:t,visible:n}=e;if(n){let a=j.filter(e=>!t.includes(e));B(a)}else{let o=[...j,...t];B(o)}},ea=e=>{switch(e.type){case E.C.ERROR_NEEDS_REGISTRATION:et();break;case E.C.CONNECTED_USER_INFO:O(e,f,u),P(t=>[...t,e]);break;case E.C.CHAT:P(t=>[...t,e]);break;case E.C.NAME_CHANGE:R(e,U,P);break;case E.C.USER_JOINED:P(t=>[...t,e]);break;case E.C.SYSTEM:P(t=>[...t,e]);break;case E.C.CHAT_ACTION:P(t=>[...t,e]);break;case E.C.VISIBILITY_UPDATE:en(e);break;default:console.error("Unknown socket message type: ",e.type)}},eo=async()=>{try{let e=await d.getChatHistory(H);P(t=>[...t,...e])}catch(t){console.error("ChatService -> getChatHistory() ERROR: \n".concat(t))}},ei=async()=>{try{let{socketHostOverride:t}=_,n=t||window.location.toString();(e=new h(H,"/ws",n)).handleMessage=ea,J(e)}catch(a){console.error("ChatService -> startChat() ERROR: \n".concat(a))}},er=()=>{};return(0,r.useEffect)(()=>{try{if(window.configHydration){let e=JSON.parse(window.configHydration);m(e),Q(!0)}}catch(t){console.error("Error parsing config hydration",t)}try{if(window.statusHydration){let n=JSON.parse(window.statusHydration);D(n),X(!0)}}catch(a){console.error("error parsing status hydration",a)}},[]),(0,r.useEffect)(()=>{W&&$&&x(i.Loaded)},[W,$]),(0,r.useEffect)(()=>{!_.chatDisabled&&H&&$&&ei()},[$,H]),(0,r.useEffect)(()=>{er()},[U]),(0,r.useEffect)(()=>(K(),ee(),z(),clearInterval(a),a=setInterval(()=>{z()},5e3),()=>{clearInterval(a)}),[]),(0,r.useEffect)(()=>{H&&eo()},[H]),(0,r.useEffect)(()=>{n.onTransition(e=>{if(!e.changed)return;let t=(0,y.YR)(e.meta);Z(t)})},[]),null}},91951:function(e,t,n){var a,o;n.d(t,{C:function(){return a}}),(o=a||(a={})).CHAT="CHAT",o.PING="PING",o.NAME_CHANGE="NAME_CHANGE",o.COLOR_CHANGE="COLOR_CHANGE",o.PONG="PONG",o.SYSTEM="SYSTEM",o.USER_JOINED="USER_JOINED",o.CHAT_ACTION="CHAT_ACTION",o.FEDIVERSE_ENGAGEMENT_FOLLOW="FEDIVERSE_ENGAGEMENT_FOLLOW",o.FEDIVERSE_ENGAGEMENT_LIKE="FEDIVERSE_ENGAGEMENT_LIKE",o.FEDIVERSE_ENGAGEMENT_REPOST="FEDIVERSE_ENGAGEMENT_REPOST",o.CONNECTED_USER_INFO="CONNECTED_USER_INFO",o.ERROR_USER_DISABLED="ERROR_USER_DISABLED",o.ERROR_NEEDS_REGISTRATION="ERROR_NEEDS_REGISTRATION",o.ERROR_MAX_CONNECTIONS_EXCEEDED="ERROR_MAX_CONNECTIONS_EXCEEDED",o.VISIBILITY_UPDATE="VISIBILITY-UPDATE"},77278:function(e,t,n){function a(e){let t="string"==typeof e?new Date(e):e;return(new Date-t)/864e5}function o(e){return Object.keys(e).reduce((t,n)=>{let a=e[n];return Object.assign(t,a),t},{})}n.d(t,{Xb:function(){return a},YR:function(){return o}})},72581:function(e,t,n){n.d(t,{$o:function(){return o},dA:function(){return a},qQ:function(){return i}});let a={username:"username",hasDisplayedNotificationModal:"HAS_DISPLAYED_NOTIFICATION_MODAL",userVisitCount:"USER_VISIT_COUNT"};function o(e){try{return localStorage.getItem(e)}catch(t){}return null}function i(e,t){try{return""!==t&&null!==t?localStorage.setItem(e,t):localStorage.removeItem(e),!0}catch(n){}return!1}}}]);