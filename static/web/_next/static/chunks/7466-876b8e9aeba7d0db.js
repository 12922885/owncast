"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7466],{77466:function(t,e,n){n.d(e,{me:function(){return H},FI:function(){return O},Q:function(){return k},L4:function(){return C},j$:function(){return v},ZA:function(){return T},g1:function(){return A},g8:function(){return L},db:function(){return R},ap:function(){return D},di:function(){return F},pT:function(){return G},hz:function(){return I},YW:function(){return P},We:function(){return _},RI:function(){return b},pH:function(){return U},Gt:function(){return m}});var o=n(67294),c=n(4480),a=n(23917);var r=class{static async getConfig(){const t=await fetch("/api/config");return await t.json()}},s=n(64777);var i=class{static async getChatHistory(t){return await(0,s.$l)("".concat("/api/chat","?accessToken=").concat(t))}static async registerUser(t){const e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({displayName:t})};return await(0,s.$l)("/api/chat/register",e)}},u=n(91951);class l{createAndConnect(t){const e=new URL(t);e.protocol="https:"===window.location.protocol?"wss:":"ws:",e.pathname="/ws",e.port="3000"===window.location.port?"8080":window.location.port,e.searchParams.append("accessToken",this.accessToken),console.debug("connecting to ",e.toString());const n=new WebSocket(e.toString());n.onopen=this.onOpen.bind(this),n.onerror=this.onError.bind(this),n.onmessage=this.onMessage.bind(this),this.websocket=n}onOpen(){this.websocketReconnectTimer&&clearTimeout(this.websocketReconnectTimer)}onError(t){var e;e="Socket error: ".concat(t),console.error("Chat has been disconnected and is likely not working for you. It's possible you were removed from chat. If this is a server configuration issue, visit troubleshooting steps to resolve. https://owncast.online/docs/troubleshooting/#chat-is-disabled: ".concat(e)),this.websocket.close(),this.isShutdown||this.scheduleReconnect()}scheduleReconnect(){this.websocketReconnectTimer&&clearTimeout(this.websocketReconnectTimer),this.backOff*=2,this.websocketReconnectTimer=setTimeout(this.createAndConnect,5e3+Math.min(this.backOff,1e4))}shutdown(){this.isShutdown=!0,this.websocket.close()}onMessage(t){const e=t.data.split("\n");let n;for(let c=0;c<e.length;c++){try{n=JSON.parse(e[c]),this.handleMessage&&this.handleMessage(n)}catch(o){return void console.error(o,o.data)}if(!n.type)return void console.error("No type provided",n);if(n.type===u.C.PING)return void this.sendPong()}}isConnected(){var t,e;return(null===(t=this.websocket)||void 0===t?void 0:t.readyState)===(null===(e=this.websocket)||void 0===e?void 0:e.OPEN)}send(t){t.type&&u.C[t.type]||console.warn('Outbound message: Unknown socket message type: "'.concat(t.type,'" sent.'));const e=JSON.stringify(t);this.websocket.send(e)}sendPong(){const t={type:u.C.PONG};this.send(t)}constructor(t,e,n){this.isShutdown=!1,this.backOff=1e3,this.accessToken=t,this.path=e,this.websocketReconnectTimer=null,this.isShutdown=!1,this.createAndConnect=this.createAndConnect.bind(this),this.shutdown=this.shutdown.bind(this),this.createAndConnect(n)}}var f=n(4723);var d;!function(t){t.Loading="LOADING",t.Loaded="LOADED",t.Online="ONLINE",t.Offline="OFFLINE",t.NeedsRegister="NEEDS_REGISTER",t.Fail="FAIL"}(d||(d={}));var h=(0,f.C)({id:"appState",initial:"loading",predictableActionArguments:!0,states:{loading:{meta:{chatAvailable:!1,chatLoading:!1,videoAvailable:!1,appLoading:!0},on:{NEEDS_REGISTER:{target:"loading"},LOADED:{target:"ready"},FAIL:{target:"serverFailure"}}},ready:{initial:"offline",states:{online:{meta:{chatAvailable:!0,chatLoading:!1,videoAvailable:!0,appLoading:!1},on:{OFFLINE:{target:"goodbye"}}},offline:{meta:{chatAvailable:!1,chatLoading:!1,videoAvailable:!1,appLoading:!1},on:{ONLINE:{target:"online"}}},goodbye:{on:{ONLINE:{target:"online"}},meta:{chatAvailable:!0,chatLoading:!1,videoAvailable:!1,appLoading:!1},after:{3e5:{target:"offline"}}}}},serverFailure:{type:"final"},userfailure:{type:"final"}}}),E=n(72581),g=n(77278);var y=function(t,e,n){const{user:o}=t,{id:c,displayName:a,displayColor:r,scopes:s,authenticated:i}=o;e(i),n({id:c.toString(),displayName:a,displayColor:r,isModerator:null===s||void 0===s?void 0:s.includes("MODERATOR")})};var p=class{static async getStatus(){const t=await fetch("/api/status");return await t.json()}};var w=function(t,e){e((e=>[...e,t]))};c.zl.RECOIL_DUPLICATE_ATOM_KEY_CHECKING_ENABLED=!1;const N="accessToken";let S;const b=(0,c.cn)({key:"serverStatusState",default:{online:!1,viewerCount:0,serverTime:new Date}}),A=(0,c.cn)({key:"clientConfigState",default:{name:"",summary:"",offlineMessage:"",logo:"",tags:[],version:"",nsfw:!1,extraPageContent:"",socialHandles:[],chatDisabled:!1,externalActions:[],customStyles:"",appearanceVariables:new Map,maxSocketPayloadSize:0,federation:{enabled:!1,account:"",followerCount:0},notifications:{browser:{enabled:!1,publicKey:""}},authentication:{indieAuthEnabled:!1}}}),O=(0,c.cn)({key:"accessTokenAtom",default:null}),R=(0,c.cn)({key:"currentUserAtom",default:null}),v=(0,c.cn)({key:"chatMessages",default:[]}),C=(0,c.cn)({key:"chatAuthenticatedAtom",default:!1}),m=(0,c.cn)({key:"websocketServiceAtom",default:null,dangerouslyAllowMutability:!0}),k=(0,c.cn)({key:"appState",default:{chatAvailable:!1,chatLoading:!0,videoAvailable:!1,appLoading:!0}}),I=(0,c.cn)({key:"isMobileAtom",default:void 0}),T=(0,c.cn)({key:"chatVisibilityToggleAtom",default:!0}),_=(0,c.cn)({key:"isVideoPlayingAtom",default:!1}),D=(0,c.cn)({key:"fatalErrorStateAtom",default:null}),L=(0,c.cn)({key:"clockSkewAtom",default:0}),M=(0,c.cn)({key:"removedMessageIds",default:[]}),G=(0,c.nZ)({key:"isChatVisibleSelector",get:t=>{let{get:e}=t;const n=e(k),o=e(T);return e(O)&&n.chatAvailable&&o}}),F=(0,c.nZ)({key:"isChatAvailableSelector",get:t=>{let{get:e}=t;const n=e(k);return e(O)&&n.chatAvailable}}),P=(0,c.nZ)({key:"isOnlineSelector",get:t=>{let{get:e}=t;const n=e(k),o=e(_);return n.videoAvailable||o}}),U=(0,c.nZ)({key:"visibleChatMessagesSelector",get:t=>{let{get:e}=t;const n=e(v),o=e(M);return n.filter((t=>!o.includes(t.id)))}}),H=()=>{const[t,e,n]=(0,a.e)(h),[s,f]=(0,c.FV)(R),I=(0,c.Zl)(C),[T,_]=(0,c.FV)(A),[G,F]=(0,c.FV)(b),P=(0,c.Zl)(L),[U,H]=(0,c.FV)(v),[V,Y]=(0,c.FV)(O),B=(0,c.Zl)(k),j=(0,c.Zl)(D),J=(0,c.Zl)(m),[Z,W]=(0,c.FV)(M),[,$]=(0,o.useState)(!1),[K,Q]=(0,o.useState)(!1);let X;const x=(t,e)=>{j({title:t,message:e})},q=t=>{e({type:t})},z=async()=>{try{const t=await p.getStatus();F(t),$(!0);const{serverTime:e}=t,n=new Date(e).getTime()-Date.now();P(n),j(null)}catch(t){q(d.Fail),x("Unable to reach Owncast server","Owncast cannot launch. Please make sure the Owncast server is running."),console.error("serverStatusState -> getStatus() ERROR: \n".concat(t))}},tt=async t=>{const e=(0,E.$o)(N);if(e)Y(e);else try{q(d.NeedsRegister);const e=await i.registerUser(t),{accessToken:n,displayName:o,displayColor:c}=e;if(!n)return;f({...s,displayName:o,displayColor:c}),Y(n),(0,E.qQ)(N,n)}catch(n){q(d.Fail),console.error("ChatService -> registerUser() ERROR: \n".concat(n))}},et=t=>{switch(t.type){case u.C.ERROR_NEEDS_REGISTRATION:(0,E.qQ)(N,""),Y(null),tt();break;case u.C.CONNECTED_USER_INFO:y(t,I,f),H((e=>[...e,t]));break;case u.C.CHAT:H((e=>[...e,t]));break;case u.C.NAME_CHANGE:w(t,H);break;case u.C.USER_JOINED:case u.C.SYSTEM:case u.C.CHAT_ACTION:H((e=>[...e,t]));break;case u.C.VISIBILITY_UPDATE:(t=>{const{ids:e,visible:n}=t;if(n){const t=Z.filter((t=>!e.includes(t)));W(t)}else{const t=[...Z,...e];W(t)}})(t);break;default:console.error("Unknown socket message type: ",t.type)}};return(0,o.useEffect)((()=>{try{if(window.configHydration){const t=JSON.parse(window.configHydration);_(t),Q(!0)}}catch(t){console.error("Error parsing config hydration",t)}try{if(window.statusHydration){const t=JSON.parse(window.statusHydration);F(t),$(!0)}}catch(e){console.error("error parsing status hydration",e)}}),[]),(0,o.useEffect)((()=>{var e;e=G,t.matches("loading")?q(d.Loaded):e.online&&t.matches("ready")?q(d.Online):e.online||t.matches("ready.offline")||q(d.Offline)}),[G]),(0,o.useEffect)((()=>{!T.chatDisabled&&V&&K&&(async()=>{try{const{socketHostOverride:t}=T,e=t||window.location.toString();X=new l(V,"/ws",e),X.handleMessage=et,J(X)}catch(t){console.error("ChatService -> startChat() ERROR: \n".concat(t))}})()}),[K,V]),(0,o.useEffect)((()=>{}),[U]),(0,o.useEffect)((()=>((async()=>{try{const t=await r.getConfig();_(t),j(null),Q(!0)}catch(t){x("Unable to reach Owncast server","Owncast cannot launch. Please make sure the Owncast server is running."),console.error("ClientConfigService -> getConfig() ERROR: \n".concat(t))}})(),tt(),z(),clearInterval(S),S=setInterval((()=>{z()}),5e3),()=>{clearInterval(S)})),[]),(0,o.useEffect)((()=>{V&&(async()=>{try{const t=await i.getChatHistory(V);H((e=>[...e,...t]))}catch(t){console.error("ChatService -> getChatHistory() ERROR: \n".concat(t))}})()}),[V]),(0,o.useEffect)((()=>{n.onTransition((t=>{const e=(0,g.YR)(t.meta);B(e)}))}),[]),null}},91951:function(t,e,n){var o;n.d(e,{C:function(){return o}}),function(t){t.CHAT="CHAT",t.PING="PING",t.NAME_CHANGE="NAME_CHANGE",t.COLOR_CHANGE="COLOR_CHANGE",t.PONG="PONG",t.SYSTEM="SYSTEM",t.USER_JOINED="USER_JOINED",t.CHAT_ACTION="CHAT_ACTION",t.FEDIVERSE_ENGAGEMENT_FOLLOW="FEDIVERSE_ENGAGEMENT_FOLLOW",t.FEDIVERSE_ENGAGEMENT_LIKE="FEDIVERSE_ENGAGEMENT_LIKE",t.FEDIVERSE_ENGAGEMENT_REPOST="FEDIVERSE_ENGAGEMENT_REPOST",t.CONNECTED_USER_INFO="CONNECTED_USER_INFO",t.ERROR_USER_DISABLED="ERROR_USER_DISABLED",t.ERROR_NEEDS_REGISTRATION="ERROR_NEEDS_REGISTRATION",t.ERROR_MAX_CONNECTIONS_EXCEEDED="ERROR_MAX_CONNECTIONS_EXCEEDED",t.VISIBILITY_UPDATE="VISIBILITY-UPDATE"}(o||(o={}))},64777:function(t,e,n){n.d(e,{$i:function(){return M},$l:function(){return Z},Bu:function(){return p},E8:function(){return P},Ff:function(){return m},GC:function(){return S},GR:function(){return Q},HP:function(){return F},IO:function(){return T},Kp:function(){return E},Kt:function(){return $},M_:function(){return D},N$:function(){return Y},NE:function(){return i},NM:function(){return y},Q_:function(){return u},Qc:function(){return C},RB:function(){return w},UJ:function(){return j},WB:function(){return r},WE:function(){return R},WQ:function(){return O},Wr:function(){return I},XA:function(){return _},Y9:function(){return U},a_:function(){return h},ao:function(){return f},bl:function(){return l},e_:function(){return G},hn:function(){return v},iG:function(){return L},iV:function(){return d},jr:function(){return N},kb:function(){return H},kg:function(){return W},ms:function(){return k},nx:function(){return b},op:function(){return V},qk:function(){return g},rQ:function(){return J},sG:function(){return A},um:function(){return B}});var o=n(34155);const c=o.env.NEXT_PUBLIC_ADMIN_USERNAME,a=o.env.NEXT_PUBLIC_ADMIN_STREAMKEY,r="/",s="".concat(r,"api/admin/"),i=15e3,u="".concat(s,"status"),l=("".concat(s,"disconnect"),"".concat(s,"changekey"),"".concat(s,"serverconfig")),f="".concat(s,"config"),d="".concat(s,"viewersOverTime"),h="".concat(s,"viewers"),E="".concat(s,"chat/clients"),g="".concat(s,"chat/users/disabled"),y="".concat(s,"chat/users/setenabled"),p="".concat(s,"chat/users/ipbans"),w="".concat(s,"chat/users/ipbans/remove"),N="".concat(s,"chat/users/setmoderator"),S="".concat(s,"chat/users/moderators"),b="".concat(s,"hardwarestats"),A="".concat(s,"logs"),O="".concat(s,"logs/warnings"),R="".concat(s,"chat/messages"),v="/api/admin/chat/messagevisibility",C="".concat(s,"emoji/upload"),m="".concat(s,"emoji/delete"),k="".concat(s,"accesstokens"),I="".concat(s,"accesstokens/delete"),T="".concat(s,"accesstokens/create"),_="".concat(s,"webhooks"),D="".concat(s,"webhooks/delete"),L="".concat(s,"webhooks/create"),M="".concat(r,"api/socialplatforms"),G=("".concat(s,"api/externalactions"),"".concat(s,"federation/send")),F="".concat(s,"followers"),P="".concat(s,"followers/pending"),U="".concat(s,"followers/blocked"),H="".concat(s,"followers/approve"),V="".concat(s,"federation/actions"),Y="".concat(s,"metrics/video"),B="".concat(s,"config/streamkeys"),j="".concat(s,"yp/reset");async function J(t,e){const{data:n,method:o="GET",auth:r=!0}=e||{},s={method:o};if(n&&(s.body=JSON.stringify(n)),r&&c&&a){const t=btoa("".concat(c,":").concat(a));s.headers={Authorization:"Basic ".concat(t)},s.mode="cors",s.credentials="include"}try{const e=await fetch(t,s),n=await e.json();if(!e.ok){const t=n.message||"An error has occurred: ".concat(e.status);throw new Error(t)}return n}catch(i){return console.error(i),i}}async function Z(t,e){return J(t,{method:"GET",auth:!1,...e})}async function W(t){try{const e=await fetch(t,{referrerPolicy:"no-referrer",referrer:""});if(!e.ok){const t="An error has occured: ".concat(e.status);throw new Error(t)}return await e.json()}catch(e){console.log(e)}return{}}async function $(){return W("https://api.github.com/repos/owncast/owncast/releases/latest")}const K=/^\d+(\.\d+){0,2}$/;async function Q(t){let e=(await $()).tag_name;return"v"===e.substr(0,1)&&(e=e.substr(1)),function(t,e){if(!t||!e||0===t.length||0===e.length)return!1;if(t===e)return!0;if(K.test(t)&&K.test(e)){const n=t.split(".");for(;n.length<3;)n.push("0");const o=e.split(".");for(;o.length<3;)o.push("0");for(let t=0;t<3;t++){const e=parseInt(n[t],10),c=parseInt(o[t],10);if(e!==c)return e>c}return!0}return t>=e}(t,e)?null:e}},77278:function(t,e,n){function o(t){const e="string"===typeof t?new Date(t):t;return(new Date-e)/864e5}n.d(e,{Xb:function(){return o},YR:function(){return c}});function c(t){return Object.keys(t).reduce(((e,n)=>{const o=t[n];return Object.assign(e,o),e}),{})}},72581:function(t,e,n){n.d(e,{$o:function(){return c},dA:function(){return o},qQ:function(){return a}});const o={username:"username",hasDisplayedNotificationModal:"HAS_DISPLAYED_NOTIFICATION_MODAL",userVisitCount:"USER_VISIT_COUNT"};function c(t){try{return localStorage.getItem(t)}catch(e){}return null}function a(t,e){try{return""!==e&&null!==e?localStorage.setItem(t,e):localStorage.removeItem(t),!0}catch(n){}return!1}}}]);
//# sourceMappingURL=7466-876b8e9aeba7d0db.js.map